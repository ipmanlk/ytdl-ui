<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Easy Youtube Download</title>
	<link rel="stylesheet" href="./css/metro-bootstrap.min.css">
	<link rel="stylesheet" href="./css/fontawesome.css">
	<script src="./js/jquery.min.js"></script>
	<script src="./js/bootstrap.min.js"></script>
	<script></script>
</head>

<body>
	<div class="container">
		<div class="page-header">
			<h1>
				Easy YT Downloader
				<small>By www.navinda.xyz</small>
			</h1>
		</div>

		<div id="panelSearch">
			<div id="txtUrlGroup" class="input-group input-group-lg">
				<input id="txtVidUrl" type="text" class="form-control input-lg" placeholder="https://www.youtube.com/watch?v=jj8NKUWrmlo">
				<span class="input-group-addon">
					<i class="fas fa-video"></i>
				</span>
			</div>

			<div id="progressSearch" class="progress progress-striped active" style="display: none">
				<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="100" aria-valuemin="0"
				 aria-valuemax="100" style="width: 100%;">
				</div>
			</div>

			<button id="btnSearch" class="btn btn-primary btn-primary btn-block" style="margin-top: 20px;">Search</button>


			<div id="insPanel" class="panel panel-default" style="margin-top: 20px;">
				<div class="panel-body">
					<center>
						<h4>Paste your youtube link here & click on search button to see the magic happens!</h4>
					</center>
				</div>
			</div>
		</div>

		<div id="panelDown" style="display: none; margin-bottom: 30px;">
			<div class="panel panel-default" style="margin-top: 20px;">
				<div class="panel-heading">
					Formats (Please select one)
				</div>

				<div class="panel-body">
					<div class="list-group" id="listDownloads">

					</div>
				</div>
			</div>

			<button id="btnDownload" class="btn btn-primary btn-success btn-block" disabled>Download</button>
		</div>

		<script>
			let videoDetails = {};
			let urlSelected;
			$(document).ready(function () {
				init();
			});

			function init() {
				registerEventListeners();
			}

			function registerEventListeners() {
				$("#btnSearch").click(btnSearchClick);
				$("#btnDownload").click(btnDownloadClick);
				$("#txtVidUrl").on("change keyup paste", vidUrlValidate);
			}


			function btnSearchClick() {
				if (vidUrlValidate()) {
					$("#btnSearch").attr("disabled", true);
					$("#progressSearch").fadeIn();
					let url = $("#txtVidUrl").val();
					detailsGet(url, function () {
						let formats = videoDetails.formats;
						// loop through formats
						for (i in formats) {
							$("#listDownloads").append(`<li onclick="vidDownloadSelect(this, ${i})" class="list-group-item">${listItemTextGet(formats[i])}</li>`);
						}
						$("#progressSearch").hide();
						$("#panelSearch").hide();
						$("#panelDown").fadeIn();
					});
				}
			}

			function listItemTextGet(file) {
				let filesize = file.filesize !== "best" ? (formatBytes(file.filesize)).trim() : "best";
				let format = (((file.format).split("-"))[1]).trim();
				let ext = file.ext;
				let tbr = Math.round(file.tbr);
				if (format.indexOf("audio only (DASH audio)") > -1) {
					return (`${format} - ${tbr}k - ${ext} - (${filesize})`);
				} else {
					return (`video - ${format} - ${ext} - (${filesize})`);
				}
			}

			function vidDownloadSelect(elem, code) {
				$(".list-group-item").removeClass("active");
				$(elem).addClass("active");
				urlSelected = videoDetails["formats"][code]["url"];
				$("#btnDownload").attr("disabled", false);
			}

			function btnDownloadClick() {
				window.location = urlSelected;
			}

			function detailsGet(url, callback) {
				$.get("http://localhost/Projects/youtube/info.php", { url, url }, function (data) {
					videoDetails = data;
					callback();
				}, "json")
			}

			function formatBytes(bytes, decimals) {
				if (bytes == 0) return '0 Bytes';
				var k = 1024,
					dm = decimals <= 0 ? 0 : decimals || 2,
					sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
					i = Math.floor(Math.log(bytes) / Math.log(k));
				return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
			}

			function vidUrlValidate() {
				let val = $("#txtVidUrl").val();
				let regEx = /^(http(s)??\:\/\/)?(www\.)?((youtube\.com\/watch\?v=)|(youtu.be\/))([a-zA-Z0-9\-_])+/;
				if (regEx.test(val)) {
					$("#txtUrlGroup").removeClass("has-error");
					$("#txtUrlGroup").addClass("has-success");
					return (true);
				} else {
					$("#txtUrlGroup").removeClass("has-success");
					$("#txtUrlGroup").addClass("has-error");
					// return (false);
				}
			}
		</script>
</body>

</html>